{% extends 'base.html' %}
{% load static %}

{% block content %}
<!-- Full Screen Background Image -->
<div 
    class="fixed inset-0 w-full h-full z-0"
    style="background-image: url('{% static 'images/bg2.png' %}'); background-size: cover; background-position: center; background-repeat: no-repeat;"
></div>

<div class="px-4">
    <div class="max-w-6xl mx-auto mt-6 sm:mt-10 p-4 sm:p-8 bg-gray-800 bg-opacity-90 shadow-lg rounded-lg text-gray-100 relative z-10">
   <!-- Logo and Tournament Header -->
   <div class="text-center mb-8">
       <img src="/static/images/logo.png" alt="Tournament Logo" class="mx-auto w-32 h-32 mb-4">
       <h1 class="text-4xl font-bold text-orange-400">{{ tournament.name }}</h1>
   </div>


   <!-- Tournament Description -->
   <div class="mb-8 p-4 bg-gray-900 bg-opacity-80 shadow-md rounded-lg">
       <p class="text-lg text-gray-300">{{ tournament.description }}</p>
   </div>


   <!-- Tournament Details -->
   <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
       <div class="p-4 bg-gray-900 bg-opacity-80 shadow-md rounded-lg">
           <p><strong>Category:</strong> {{ tournament.category }}</p>
           <p><strong>Match Type:</strong> {{ tournament.match_type }}</p>
           <p><strong>Total Participants:</strong> {{ participants.count }}</p>
       </div>
   </div>


   <!-- Participants Section -->
   <div class="mb-8">
       <h2 class="text-2xl font-semibold text-gray-200 mb-4">Participants</h2>
       <ul class="bg-gray-900 bg-opacity-80 shadow-md rounded-lg divide-y divide-gray-700">
           {% for participant in participants %}
               <li class="p-4 hover:bg-gray-700">{{ participant.name }}</li>
           {% empty %}
               <li class="p-4 text-gray-400">No participants have joined this tournament yet.</li>
           {% endfor %}
       </ul>
   </div>


   <!-- Button to Toggle Fixtures Panel -->
   <div class="text-center mb-8">
       <button id="toggle-fixtures-btn" class="px-4 py-2 bg-orange-500 hover:bg-orange-600 text-white font-semibold rounded-lg">
           Show Fixtures
       </button>
   </div>


   <!-- Fixtures Section (Initially Hidden) -->
   <div id="fixtures-panel" class="hidden">
       <div class="flex items-center justify-between mb-4">
    <h2 class="text-2xl font-semibold text-gray-200">Fixtures</h2>
    {% if is_host %}
        <button id="updateAllBtn" class="px-4 py-2 bg-green-500 hover:bg-green-600 text-white rounded">
            Update All
        </button>
    {% endif %}
</div>
       <ul class="bg-gray-900 bg-opacity-80 shadow-md rounded-lg divide-y divide-gray-700">
           {% for match in matches %}
               <li class="p-4 hover:bg-gray-700">
                   {% if is_host %}
                       <form method="post" action="{% url 'update_match_result' match.id %}" 
                       class="match-form flex items-center space-x-4">
                           {% csrf_token %}
                           <span class="font-medium">{{ match.player1.name }}</span>
                           <span class="text-gray-400">vs</span>
                           <span class="font-medium">{{ match.player2.name }}</span>
                           <select name="winner_id" class="bg-gray-800 text-white rounded px-2 py-1 winner-select">
                               <option value="">Select Winner</option>
                               <option value="{{ match.player1.id }}" {% if match.winner == match.player1 %}selected{% endif %}>{{ match.player1.name }}</option>
                               <option value="{{ match.player2.id }}" {% if match.winner == match.player2 %}selected{% endif %}>{{ match.player2.name }}</option>
                           </select>
                           <label class="text-gray-300 ml-2">
                               <input type="checkbox" name="draw" value="1" class="draw-checkbox"> Draw
                           </label>
                       </form>
                   {% else %}
                       <span class="font-medium">{{ match.player1.name }}</span>
                       <span class="text-gray-400">vs</span>
                       <span class="font-medium">{{ match.player2.name }}</span>
                   {% endif %}
                   {% if match.winner %}
                       <span class="ml-4 text-green-400">Winner: {{ match.winner.name }}</span>
                   {% elif match.has_result %}
                       <span class="ml-4 text-yellow-400">Match is Draw</span>
                   {% endif %}
               </li>
           {% empty %}
               <li class="p-4 text-gray-400">No fixtures available yet.</li>
           {% endfor %}
       </ul>

{% if knockout_stages %}
   <!-- ðŸ† Knockout Fixtures Grouped by Stage -->
  <div class="mt-10">
    <h2 class="text-2xl font-semibold text-orange-400 mb-4 text-center">Knockout Stages</h2>

    {% for stage, stage_matches in knockout_stages.items %}
        {% if stage != "GROUP" %}
        <div class="mb-6">
            <h3 class="text-xl font-semibold text-gray-200 mb-2 uppercase">{{ stage|title }}</h3>
            <ul class="bg-gray-900 bg-opacity-80 shadow-md rounded-lg divide-y divide-gray-700">
                {% for match in stage_matches %}
                <li class="p-4 hover:bg-gray-700">
                    {% if is_host %}
                    <form method="post" action="{% url 'update_match_result' match.id %}" 
      class="match-form flex flex-wrap items-center gap-2">
                        {% csrf_token %}
                        <span class="font-medium">{{ match.player1.name }}</span>
                        <span class="text-gray-400">vs</span>
                        <span class="font-medium">{{ match.player2.name }}</span>

                        <select name="winner_id" class="bg-gray-800 text-white rounded px-2 py-1 winner-select">
                            <option value="">Select Winner</option>
                            <option value="{{ match.player1.id }}" {% if match.winner == match.player1 %}selected{% endif %}>{{ match.player1.name }}</option>
                            <option value="{{ match.player2.id }}" {% if match.winner == match.player2 %}selected{% endif %}>{{ match.player2.name }}</option>
                        </select>

                        <label class="text-gray-300 ml-2">
                            <input type="checkbox" name="draw" value="1" class="draw-checkbox"> Draw
                        </label>

                    </form>
                    {% else %}
                    <span class="font-medium">{{ match.player1.name }}</span>
                    <span class="text-gray-400">vs</span>
                    <span class="font-medium">{{ match.player2.name }}</span>
                    {% endif %}

                    {% if match.winner %}
                    <span class="ml-4 text-green-400">Winner: {{ match.winner.name }}</span>
                    {% elif match.has_result %}
                    <span class="ml-4 text-yellow-400">Match is Draw</span>
                    {% endif %}
                </li>
                {% empty %}
                <li class="p-4 text-gray-400">No matches for this stage.</li>
                {% endfor %}
            </ul>
        </div>
        {% endif %}
    {% endfor %}
  </div>
{% endif %}
</div>

    <!-- Point Table Section -->
    <div class="mt-10">
        <h2 class="text-2xl font-semibold text-gray-200 mb-4">Point Table</h2>
            <div class="overflow-x-auto rounded-lg bg-gray-900 bg-opacity-80">
                <table class="min-w-full">
            <thead>
                <tr>
                    <th class="px-4 py-2">Player</th>
                    <th class="px-4 py-2">Played</th>
                    <th class="px-4 py-2">Wins</th>
                    <th class="px-4 py-2">Draws</th>
                    <th class="px-4 py-2">Losses</th>
                    <th class="px-4 py-2">Points</th>
                </tr>
            </thead>
            <tbody>
                {% for entry in point_table %}
                <tr>
                    <td class="px-4 py-2">{{ entry.player.name }}</td>
                    <td class="px-4 py-2">{{ entry.matches_played }}</td>
                    <td class="px-4 py-2">{{ entry.wins }}</td>
                    <td class="px-4 py-2">{{ entry.draws }}</td>
                    <td class="px-4 py-2">{{ entry.losses }}</td>
                    <td class="px-4 py-2 font-bold">{{ entry.points }}</td>
                </tr>
                {% empty %}
                <tr><td colspan="6" class="px-4 py-2 text-gray-400">No point table data yet.</td></tr>
                {% endfor %}
            </tbody>
                </table>
            </div>
</div>


<script>
// Toggle fixtures panel
document.getElementById('toggle-fixtures-btn').addEventListener('click', function () {
    const fixturesPanel = document.getElementById('fixtures-panel');
    if (fixturesPanel.classList.contains('hidden')) {
        fixturesPanel.classList.remove('hidden');
        this.textContent = 'Hide Fixtures';
    } else {
        fixturesPanel.classList.add('hidden');
        this.textContent = 'Show Fixtures';
    }
});

// Winner/Draw mutual exclusion logic
document.querySelectorAll('form').forEach(function(form) {
    const winnerSelect = form.querySelector('.winner-select');
    const drawCheckbox = form.querySelector('.draw-checkbox');
    if (winnerSelect && drawCheckbox) {
        // Initial state: if a winner is selected, disable draw; if draw is checked, disable winner
        function updateState() {
            if (drawCheckbox.checked) {
                winnerSelect.disabled = true;
            } else {
                winnerSelect.disabled = false;
            }
            if (winnerSelect.value) {
                drawCheckbox.disabled = true;
            } else {
                drawCheckbox.disabled = false;
            }
        }
        // Set initial state
        drawCheckbox.checked = false;
        updateState();
        // Event listeners
        drawCheckbox.addEventListener('change', updateState);
        winnerSelect.addEventListener('change', updateState);
    }
});
// Update All button logic
document.getElementById("updateAllBtn")?.addEventListener("click", function () {
    const forms = document.querySelectorAll(".match-form");
    forms.forEach(form => {
        form.submit();  // Submit each match form
    });
});

</script>
{% endblock %}
